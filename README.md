# 🏰 The Kingdom - Medieval Idle/Clicker Game

A sophisticated browser-based idle/clicker game built with Next.js 15, React 19, and TypeScript. Players build and manage a medieval kingdom through resource management, building construction, technology research, and strategic prestige mechanics.

## 🎮 Game Overview

**The Kingdom** is a data-driven idle game where players start with basic resources and gradually build an empire through:

- **Resource Management**: Gold, Wood, Stone, Food, Prestige, and Research Points
- **Building Construction**: 8 unique buildings with different production capabilities
- **Technology Tree**: 6 technologies with prerequisites and research time
- **Prestige System**: Reset mechanics with permanent upgrades
- **Dynamic Events**: 8 random events that affect gameplay
- **Performance Optimization**: High-frequency game loop with batched updates

## 🚀 Features

### Core Gameplay
- **Click Actions**: Manual resource generation through "Royal Decrees"
- **Passive Production**: Buildings continuously generate resources
- **Technology Research**: Unlock new buildings and capabilities
- **Prestige Mechanics**: Reset progress for permanent bonuses
- **Event System**: Random events with choices and consequences

### Technical Features
- **High-Performance Game Loop**: 20 FPS game logic with optimized state batching
- **Auto-Save System**: Automatic saves every 30 seconds with offline progress
- **Import/Export**: Save file management with base64 encoding
- **Performance Monitoring**: Real-time metrics for tick time, render time, and memory usage
- **Responsive Design**: Modern UI with CSS modules and SCSS
- **Type Safety**: Full TypeScript implementation with strict typing
- **Error Handling**: React Error Boundary with graceful fallbacks
- **Utility Functions**: Number formatting, debouncing, and safe JSON parsing
- **SVG Icon System**: Custom medieval-themed icon sprites for all game elements

## 🏗️ Architecture

### Project Structure
```
src/
├── app/                    # Next.js app router
├── components/            # React components
│   ├── game/             # Game-specific components
│   └── ui/               # Reusable UI components
├── lib/game/             # Core game logic
│   ├── config/           # Game configuration
│   ├── contexts/         # React contexts
│   ├── hooks/            # Custom React hooks
│   └── systems/          # Game systems
└── styles/               # SCSS styling
```

### Core Systems

#### 1. Game Loop (`useGameLoop.tsx`)
- **Interval System**:  game logic (20 FPS) 
- **Performance Monitoring**: Tracks tick duration and performance metrics

#### 2. Configuration System (`config/`)
- **Data-Driven Design**: All game content defined in configuration objects
- **Type Safety**: Strong typing for all game entities
- **Modular Structure**: Separate configs for resources, buildings, technologies, etc.

#### 3. State Management (`GameContext.tsx`)
- **Centralized State**: Single source of truth for game state
- **Custom Hooks**: Specialized hooks for different game systems
- **Performance Optimized**: Memoized calculations and efficient updates

#### 4. Save System (`saveSystem.ts`)
- **Local Storage**: Persistent game saves
- **Version Control**: Save compatibility management (currently version 4)
- **Import/Export**: Base64 encoded save files
- **Offline Progress**: Calculates progress when game is reopened
- **Auto-Save**: Automatic saves every 30 seconds
- **Manual Save**: Player-initiated saves with logging
- **Save Validation**: Version checking and error handling for corrupted saves

#### 5. Utility System (`utils.ts`)
- **Number Formatting**: K/M/B/T notation for large values
- **Safe JSON Parsing**: Error handling for save file operations
- **Base64 Encoding**: Cross-platform encoding/decoding
- **Debouncing**: Performance optimization for user interactions

#### 6. State Management (`gameState.ts`)
- **Immutable Updates**: Pure functions for state modifications
- **Structural Sharing**: Efficient state updates with minimal object creation
- **Resource Management**: Safe resource access and modification
- **Building Unlocking**: Technology-based building availability

#### 7. Custom Hooks System
- **useGameActions**: Optimized action handlers with functional state updates
- **useGameCalculations**: Memoized calculations to prevent unnecessary recalculations
- **useGameTime**: Timer management for events and saves with 1-second updates
- **usePerformanceMonitor**: Performance metrics with configurable update intervals
- **useSaveSystem**: Comprehensive save management with offline progress processing

## 🎯 Game Mechanics

### Resources
- **Gold**: Primary currency, generated by blacksmiths and libraries
- **Wood**: Basic building material, harvested by woodcutters
- **Stone**: Construction material, extracted by quarries
- **Food**: Sustenance for population, grown on farms
- **Prestige**: Advanced currency, earned through castles and prestige resets
- **Research Points**: Technology advancement currency, generated by libraries and universities

### Buildings
| Building | Cost | Production | Requirements |
|----------|------|------------|--------------|
| **Woodcutter's Hut** | 15 Gold | 1.2 Wood/s | None |
| **Quarry** | 30 Gold, 5 Wood | 0.8 Stone/s | None |
| **Farm** | 25 Gold, 8 Wood | 1.5 Food/s | None |
| **Blacksmith** | 50 Gold, 15 Wood, 10 Stone | 2.5 Gold/s | None |
| **Castle** | 200 Gold, 50 Wood, 100 Stone, 20 Food | 0.1 Prestige/s | None |
| **Library** | 100 Gold, 30 Wood, 20 Stone | 1.0 Gold/s, 0.1 RP/s | Writing |
| **University** | 300 Gold, 80 Wood, 60 Stone, 30 Food | 3.0 Gold/s, 0.05 Prestige/s, 0.3 RP/s | Writing, Mathematics |
| **Laboratory** | 500 Gold, 100 Wood, 150 Stone, 50 Food | 5.0 Gold/s, 0.1 Prestige/s, 0.5 RP/s | Chemistry, Engineering |

### Technologies
| Technology | Cost | Research Time | Unlocks | Prerequisites |
|------------|------|---------------|---------|---------------|
| **Writing** | 50 Gold, 20 Wood | 30s | Library | None |
| **Mathematics** | 100 Gold, 30 Wood, 20 Stone | 60s | University | Writing |
| **Engineering** | 150 Gold, 50 Wood, 40 Stone | 90s | None | Writing, Mathematics |
| **Chemistry** | 200 Gold, 60 Wood, 50 Stone, 20 Food | 120s | Laboratory | Mathematics, Engineering |
| **Physics** | 300 Gold, 80 Wood, 70 Stone, 30 Food | 180s | None | Mathematics, Chemistry |
| **Biology** | 400 Gold, 100 Wood, 90 Stone, 50 Food | 240s | None | Chemistry, Physics |

**Research System Features:**
- **Single Research**: Only one technology can be researched at a time
- **Progress Tracking**: Real-time progress bars and time remaining
- **Prerequisite Checking**: Technologies unlock based on completed research
- **Resource Deduction**: Costs are paid upfront when research begins

### Prestige Upgrades
| Upgrade | Effect | Max Level | Cost Curve |
|---------|--------|-----------|------------|
| **Royal Decrees** | +25% click gains per level | 20 | 5 × 1.6^level |
| **Master Craftsmen** | -3% building costs per level | 25 | 8 × 1.7^level |
| **Fertile Lands** | +20% Food production per level | 25 | 6 × 1.65^level |
| **Military Might** | +20% Prestige production per level | 20 | 10 × 1.7^level |

### Events
The game features 8 dynamic events that occur randomly:
- **Merchant Visit**: Trade resources for gold
- **Bandit Raid**: Defend against or pay tribute to bandits
- **Bountiful Harvest**: Bonus resources from nature
- **Drought**: Reduced production with prayer options
- **Royal Tax**: Pay taxes or lose prestige
- **Mysterious Stranger**: Risky prestige for gold trade
- **Plague**: Population reduction with treatment options
- **Festival**: Production boost events

**Event System Features:**
- **Auto-Resolution**: Events automatically resolve after 30 seconds if no choice is made
- **Event History**: Tracks last 50 event choices with timestamps
- **Random Timing**: Events occur between 10-30 seconds initially, then 60-180 seconds
- **Choice Requirements**: Some choices require specific resources to be available

## 🛠️ Technical Implementation

### Performance Optimizations
- **State Batching**: Multiple game ticks processed before React updates
- **Memoized Calculations**: Expensive operations cached and reused
- **Pure Functions**: Immutable state updates for predictable behavior
- **Efficient Rendering**: React.memo and optimized re-render logic
- **Offline Progress**: Single-pass calculation for offline time instead of multiple ticks
- **Structural Sharing**: Minimal object creation during state updates
- **Performance Monitoring**: Configurable metrics collection with frame-based updates

```typescript
// High-frequency game logic (20 FPS)
const gameLoopInterval = setInterval(() => {
  const tickResult = processTick();
  if (tickResult) {
    pendingStateUpdatesRef.current = tickResult.newState;
    onTickComplete(tickResult.tickDuration);
  }
}, 50); // 20 FPS

// Synchronized React updates (20 FPS)
const stateUpdateInterval = setInterval(() => {
  if (pendingStateUpdatesRef.current) {
    onStateUpdate(pendingStateUpdatesRef.current);
    pendingStateUpdatesRef.current = null;
  }
}, 50);
```

**Game Loop Design Philosophy:**
The game loop is intentionally designed to process every tick without early returns because idle games require continuous resource generation and event processing. Each tick (50ms) contains meaningful updates:

- **Resource Production**: Buildings continuously generate resources
- **Event System**: Random events can trigger at any time
- **Research Progress**: Technology research advances continuously
- **Time-based Mechanics**: Save timers, event timers, etc.

The built-in `if (newState === currentState) return null;` check in `useGameLoop` is sufficient to prevent unnecessary processing when no actual changes occur, but this is rare in practice due to the continuous nature of idle game mechanics.

### State Management Pattern
```typescript
// Immutable state updates
export function buyBuilding(state: GameState, key: BuildingKey): GameState {
  const cost = costFor(state, key);
  if (!canAfford(state, cost)) return state;
  
  const newState = pay(state, cost);
  const current = getBuildingCount(newState, key);
  return updateBuildingCount(newState, key, current + 1);
}
```

## 🎨 UI/UX Design

### Visual Design
- **Medieval Theme**: Dark color scheme with blue accents
- **Card-Based Layout**: Organized sections for different game aspects
- **Responsive Grid**: Adaptive layout for different screen sizes
- **Icon System**: SVG sprites for consistent visual language
- **Custom Icons**: 30+ hand-crafted SVG icons for resources, buildings, technologies, and events
- **Typography**: Geist font family for modern, readable text
- **Color Variables**: CSS custom properties for consistent theming

### User Experience
- **Real-Time Feedback**: Live resource counters and production rates
- **Progress Indicators**: Research progress bars and event timers
- **Accessibility**: Clear button states and readable typography
- **Performance Metrics**: Built-in monitoring for debugging

## 🚀 Getting Started

### Prerequisites
- Node.js 18+ 
- npm or yarn

### Technology Stack
- **Framework**: Next.js 15 with App Router
- **UI Library**: React 19 with modern hooks
- **Language**: TypeScript 5 with strict mode
- **Styling**: SCSS with CSS Modules
- **Fonts**: Google Fonts (Geist Sans & Geist Mono)
- **Build Tool**: Turbopack for development
- **Linting**: ESLint with Next.js rules

### Installation
```bash
# Clone the repository
git clone <repository-url>
cd the-kingdom

# Install dependencies
npm install

# Start development server
npm run dev
```

### Available Scripts
- `npm run dev` - Start development server with Turbopack
- `npm run build` - Build for production
- `npm run start` - Start production server
- `npm run lint` - Run ESLint

## 🔧 Configuration

### Adding New Content
The game is designed to be easily extensible. To add new content:

1. **Resources**: Add to `src/lib/game/config/resources.ts`
2. **Buildings**: Add to `src/lib/game/config/buildings.ts`
3. **Technologies**: Add to `src/lib/game/config/technologies.ts`
4. **Upgrades**: Add to `src/lib/game/config/prestige.ts`
5. **Events**: Add to `src/lib/game/config/events.ts`

### Adding New Icons
To add new SVG icons:
1. Add the icon definition to `src/components/ui/SvgSprites.tsx`
2. Reference the icon ID in your configuration
3. Icons use a consistent 24x24 viewBox with medieval theme colors

### State Management
- **Immutable Updates**: All state changes return new objects
- **Pure Functions**: No side effects in game logic functions
- **Structural Sharing**: Efficient updates with minimal object recreation
- **Type Safety**: Full TypeScript coverage for all game entities

### Example: Adding a New Building
```typescript
// In buildings.ts
export const BUILDINGS: Record<BuildingKey, BuildingDef> = {
  // ... existing buildings
  newBuilding: {
    name: 'New Building',
    icon: 'ic-new-building',
    desc: 'Description of the new building.',
    baseCost: { gold: 100, wood: 20 },
    costScale: 1.15,
    baseProd: { gold: 5.0 },
    baseUse: { food: 1.0 },
    requiresTech: 'advancedTech',
  },
};
```

## 📊 Performance Characteristics

### Game Loop Performance
- **Target FPS**: 20 FPS (50ms intervals)
- **Tick Processing**: < 1ms per tick
- **Continuous Updates**: Every game tick has meaningful changes (resource production, events, research progress)
- **No Early Returns**: The game loop is designed to process all ticks since idle games require continuous resource generation
- **State Updates**: Batched every 50ms
- **Memory Usage**: Optimized for long-running sessions

### Code Quality & Standards
- **TypeScript**: Strict mode with comprehensive type definitions
- **ESLint**: Next.js core web vitals and TypeScript rules
- **Code Style**: Functional programming with pure functions
- **Error Handling**: Graceful degradation and user-friendly error messages
- **Performance**: Optimized for 60 FPS rendering and smooth gameplay
- **Memory Management**: Efficient object creation and garbage collection
- **Console Logging**: Comprehensive logging for debugging and save operations

### Browser Compatibility
- **Modern Browsers**: Chrome 90+, Firefox 88+, Safari 14+
- **Mobile Support**: Responsive design for mobile devices
- **Offline Capable**: Local storage and offline progress calculation

## 🔮 Future Enhancements

### Planned Features
- **Cloud Saves**: Cross-device synchronization
- **Achievements**: Milestone tracking and rewards
- **Multiplayer**: Cooperative and competitive features
- **Modding Support**: User-created content system
- **Mobile App**: Native mobile application

## 🤝 Contributing

### Development Guidelines
- **TypeScript**: Strict typing and comprehensive interfaces
- **Performance**: Optimize for 60 FPS rendering and smooth gameplay
- **Testing**: Unit tests for game logic and integration tests for UI
- **Documentation**: Clear code comments and API documentation
- **Error Handling**: Implement graceful fallbacks and user-friendly error messages
- **Accessibility**: Use semantic HTML and ARIA attributes where appropriate
- **Responsive Design**: Ensure mobile-friendly layouts and interactions

### Code Style
- **Functional Programming**: Pure functions and immutable state
- **React Patterns**: Hooks-based architecture with proper memoization
- **CSS Modules**: Scoped styling with consistent naming conventions
- **Error Handling**: Graceful degradation and user-friendly error messages
- **Component Structure**: Memoized components with clear prop interfaces
- **State Updates**: Immutable state modifications with structural sharing
- **Performance**: Use React.memo and useCallback for expensive operations

## 📄 License

This project is licensed under the MIT License - see the LICENSE file for details.

## 🙏 Acknowledgments

- **Next.js Team**: For the excellent React framework
- **React Team**: For the powerful UI library
- **Idle Game Community**: For inspiration and feedback
- **Open Source Contributors**: For the tools and libraries used
- **Google Fonts**: For the Geist font family
- **SVG Community**: For the scalable vector graphics standards

---

**The Kingdom** represents a modern approach to browser-based gaming, combining the addictive mechanics of idle games with the technical sophistication of modern web development. Whether you're a player looking for an engaging gaming experience or a developer interested in game architecture, this project offers insights into building complex, performant web applications.
